Интернет-магазин Книг. Пилотное приложение

## Оглавление
- [Применение](#)
- [Как я могу развернуть проект у себя](#)
    - [URL-ссылка MongoDB](#)
    - [Секретное слово session](#)
    - [секретный ключ SendGrid](#)
    - [Email отправки](#)
    - [URL-адресс для разработки](#)
- [Запуск сервера](#)
- [Концепция MVC](#)
    - [Организация моделей (models)](#)
    - [Организация представлений (views)](#)
    - [Организация контроллеров (controller)](#)
- [Middleware](#)
    - [Отправка email-сообщений](#)
        - [Аккаунт успешно создан](#)
        - [Восстановление пароля](#)
    - [Валидациция](#)
    - [Авторизация](#)

применение
как я могу равзернуть проекту у себя
запуск сервера
модели
роуты
контроллеры
middleware
представления



## Применение
Данный pet проект создан с целью показать реализацию back-end приложения на node.js. Проект включает следующие функции, подробно описаны данной пояснительной запиской.


Функции реализованые проектом:

| Название блока| Название | Концепт реализации | Используемый пакет | Примечание |
| ------------- | -------- | ------------------ | ------------------ | ---------- |
| - | Запуск сервера | Автоматический перезапуск сервера при изменениях файлов разработки | nodemon | - |
| - | Роутинг | Управление и перенаправление запросов пользователя | express.Router | - |
|MVC| Модель| Создание структуры данных | mongoose | - |
|MVC| Представления | Отрисовка данных| express-handlebars | - |
|MVC| Контроллер | | Управление и обработка данных | mongoose | - |
|Middleware| Отправка почтовых писем|||
|Middleware| ||




### Cтруктура приложения

Перечень всех страниц приложения:
|Название страницы | Название в коде |               Короткое описание               |
| :--------------: | :-------------: | :-------------------------------------------: |
|     Главная      |      home       |            Главная страница сайта             |
|      Курсы       |     courses     |          Страница со списком курсов           |
|  Добавить курс   |       add       |          Страница добавление курсов           |
|     Профиль      |     profile     |         Страница профиля пользователя         |
|     Корзина      |      card       | Страница товаров, которые находятся в корзине |
|     Заказы       |     orders      |                Готовые покупки                |
|  Войти / Выйти   |      auth       |     Войти / выйти в аккаунт пользователя      |


-----------------------------------------------------------------------------------------------------------------------------------------------------------------

### Вводные данные

### Подключение MongoStore
```node
const session = require('express-session')
const MongoStore = require('connect-mongodb-session')(session)

const store = new MongoStore({
  collection: 'sessions',
  uri: keys.MONGODB_URL
})
```
Где: 
- `store` - `new MongoStore({})`
- `collection` - `'sessions'`
- `uri` - `keys.MONGODB_URL`



### Запуск сервера:
```node
const express = require('express')

const app = express()
const PORT = process.env.PORT || 3000

app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`)
    })
```
Где:
- `app` - `express()`
- `PORT` - `process.env.PORT`
- `listen` - 

### Подключение MongoDb:
```node
const mongoose = require('mongoose')

await mongoose.connect(keys.MONGODB_URL, {
    useNewUrlParser: true,
    useFindAndModify: false
})
```
Где:
- `mongoose.connect({})` -
- `keys.MONGODB_URL` -
- `useNewUrlParser` - `true`
- `useFindAndModify` - `false`


-----------------------------------------------------------------------------------------------------------------------------------------------------------------


# Модели

Таблица всех моделей:

| Модель | Предназначение |
| :----: | :------------: |
| course | Схема полей с типами данных для создания одного курса|
| order  | Схема полей с типами данных для создания одного заказа|
|  user  | Схема полей с типами данных для создания одного уникального пользователя|

Пример на основе userSchema так как самая трудная
Блок кода
```node
const {Schema, model} = require('mongoose')

const userSchema = new Schema({
  email: {
    type: String,
    required: true
  },
  name: String,
  password: {
    type: String,
    required: true
  },
  avatarUrl: String,
  resetToken: String,
  resetTokenExp: Date,
  cart: {
    items: [
      {
        count: {
          type: Number,
          required: true,
          default: 1
        },
        courseId: {
          type: Schema.Types.ObjectId,
          ref: 'Course',
          required: true
        }
      }
    ]
  }
})

module.exports = model('User', userSchema)
```
Где:
- `const {Schema, model} = require('mongoose')` -
- `new Schema({})` -
- `email` - 
  - `type` `String`
  - `required` `true`
- `name` - `String`
- `password` - 
  - `type` `String`
  - `required` `true`
- `avatarUrl` - `String`
- `resetToken` - `String`
- `resetTokenExp` - `Date`
- `cart` - `{items}` `{[count, courseId]}`
- `count` - 
  - `type` `Number`
  - `required` `true`
  - `default` `1`


Методы модели:

```node
userSchema.methods.removeFromCart = function(id) {
  let items = [...this.cart.items]
  const idx = items.findIndex(c => c.courseId.toString() === id.toString())

  if (items[idx].count === 1) {
    items = items.filter(c => c.courseId.toString() !== id.toString())
  } else {
    items[idx].count--
  }

  this.cart = {items}
  return this.save()
}
```
Где:
- `userSchema.methods.removeFromCart` -
- `[...this.cart.items]` - 
- `items.findIndex(c => c.courseId.toString() === id.toString())` -
- `items[idx].count === 1` -
- `items.filter(c => c.courseId.toString() !== id.toString())` -
- `items[idx].count--` -
- `this.cart = {items}` -
- `return this.save()` -

Блок кода
```node
userSchema.methods.clearCart = function() {
  this.cart = {items: []}
  return this.save()
}
```
- `userSchema.methods.clearCart` -
- `this.cart = {items: []}` -
- `return this.save()` -



-----------------------------------------------------------------------------------------------------------------------------------------------------------------

# Маршрутизация. Routes

Все запросы ко всем страницам приложения:
|Название страницы| Тип запроса |    URL-путь запроса     |       middleware       |                                     Краткое описание                                     |
| :-------------: | :---------: | :---------------------: | :--------------------: | :--------------------------------------------------------------------------------------: |
|     Главная     |     get     |           "/"           |           -            |                               Получение страницы "Главная"                               |
|      Курсы      |     get     |        "/courses"       |           -            |               Получение страницы "Курсы" и получение всех курсов магазина                |
|      Курсы      |     get     |      "/courses/:id"     |           -            |                            Получение одного курса из магазина                            |
|      Курсы      |     get     |   "/courses/:id/edit"   |          auth          |                     Получение страницы "Редактирование одного курса"                     |
|      Курсы      |     post    |     "/courses/edit"     | auth, courseValidators |                       Отправка редактируемых данных старого курса                        |
|      Курсы      |     post    |    "/courses/remove"    |          auth          |                              Удаление существующего курса                                |
|  Добавить курс  |     get     |         "/add"          |          auth          |                            Получение страницы "Добавить курс"                            |
|  Добавить курс  |     post    |         "/add"          | auth, courseValidators |   Отправка и сохранение одного курса и последующего перенаправления на страницу курсов   |
|     Профиль     |     get     |       "/profile"        |          auth          |                          Получение страницы профиля пользователя                         |
|     Профиль     |     post    |       "/profile"        |          auth          |                    Отправка редактируемых данных профиля пользователя                    |
|     Корзина     |     get     |         "/card"         |          auth          |                       Получение страницы "Корзина" и всех товаров                        |
|     Корзина     |     post    |       "/card/add"       |          auth          |       Добавление товара в "Корзину" c помощью клавиши "Купить" на странице "Курсы"       |
|     Корзина     |    delete   |    "/card/remove/:id"   |          auth          |                                   Удаление одного курса                                  |
|     Заказы      |     get     |        "/orders"        |          auth          |                               Получение страницы "Заказы"                                |
|     Заказы      |     post    |        "/orders"        |          auth          | Отправка данных на страницу "Заказы" через клавишу "Сделать заказ" на странице "Корзина" |
|   Вход / выход  |     get     |       "/auth/login"     |           -            |                   Отправка данных пользователя для входа в приложение                    |
|   Вход / выход  |     get     |       "/auth/loguot"    |           -            |                    Выход из приложения и закрытия сессии пользователя                    |
|   Вход / выход  |     get     |       "/auth/reset"     |           -            |                         Получение страницы восстановление пароля                         |
|   Вход / выход  |     get     | "/auth/password/:token" |           -            |                         Получение токена на восстановление пароля                        |
|   Вход / выход  |     post    |       "/auth/login"     |           -            |                   Отправка данных пользователя для входа в приложение                    |
|   Вход / выход  |     post    |      "/auth/register"   |    courseValidators    |           Отправка регистрационных данных для получения доступа в приложение             |
|   Вход / выход  |     post    |       "/auth/reset"     |           -            |       Отправка ранее регистрируемой почты для восстановления доступа в приложение        |
|   Вход / выход  |     post    |     "/auth/password"    |           -            |                   Отправка пароля пользователя для доступа в приложение                  |



### Страница "Главная" 

Все запросы страницы "Главная"
|Название страницы| Тип запроса |    URL-путь запроса     |       middleware       |                                     Краткое описание                                     |
| :-------------: | :---------: | :---------------------: | :--------------------: | :--------------------------------------------------------------------------------------: |
|     Главная     |     get     |           "/"           |           -            |                               Получение страницы "Главная"                               |


Блок кода
```node
const {Router} = require('express')
const router = Router()

router.get('/', (req, res) => {
  res.render('index', {
    title: 'Главная страница',
    isHome: true
  })
})
```



Все запросы страницы "Курсы"
|Название страницы| Тип запроса |    URL-путь запроса     |       middleware       |                                     Краткое описание                                     |
| :-------------: | :---------: | :---------------------: | :--------------------: | :--------------------------------------------------------------------------------------: |
|      Курсы      |     get     |        "/courses"       |           -            |               Получение страницы "Курсы" и получение всех курсов магазина                |
|      Курсы      |     get     |      "/courses/:id"     |           -            |                            Получение одного курса из магазина                            |
|      Курсы      |     get     |   "/courses/:id/edit"   |          auth          |                     Получение страницы "Редактирование одного курса"                     |
|      Курсы      |     post    |     "/courses/edit"     | auth, courseValidators |                       Отправка редактируемых данных старого курса                        |
|      Курсы      |     post    |    "/courses/remove"    |          auth          |                              Удаление существующего курса                                |


/ courses аналогичен "/"





Все запросы страницы "Добавить курс"
|Название страницы| Тип запроса |    URL-путь запроса     |       middleware       |                                     Краткое описание                                     |
| :-------------: | :---------: | :---------------------: | :--------------------: | :--------------------------------------------------------------------------------------: |
|  Добавить курс  |     get     |         "/add"          |          auth          |                            Получение страницы "Добавить курс"                            |
|  Добавить курс  |     post    |         "/add"          | auth, courseValidators |   Отправка и сохранение одного курса и последующего перенаправления на страницу курсов   |




Все запросы страницы "Профиль"
|Название страницы| Тип запроса |    URL-путь запроса     |       middleware       |                                     Краткое описание                                     |
| :-------------: | :---------: | :---------------------: | :--------------------: | :--------------------------------------------------------------------------------------: |
|     Профиль     |     get     |       "/profile"        |          auth          |                          Получение страницы профиля пользователя                         |
|     Профиль     |     post    |       "/profile"        |          auth          |                    Отправка редактируемых данных профиля пользователя                    |





Все запросы страницы "Корзина"
|Название страницы| Тип запроса |    URL-путь запроса     |       middleware       |                                     Краткое описание                                     |
| :-------------: | :---------: | :---------------------: | :--------------------: | :--------------------------------------------------------------------------------------: |
|     Корзина     |     get     |         "/card"         |          auth          |                       Получение страницы "Корзина" и всех товаров                        |
|     Корзина     |     post    |       "/card/add"       |          auth          |       Добавление товара в "Корзину" c помощью клавиши "Купить" на странице "Курсы"       |
|     Корзина     |    delete   |    "/card/remove/:id"   |          auth          |                                   Удаление одного курса                                  |




Все запросы страницы "Заказы"
|Название страницы| Тип запроса |    URL-путь запроса     |       middleware       |                                     Краткое описание                                     |
| :-------------: | :---------: | :---------------------: | :--------------------: | :--------------------------------------------------------------------------------------: |
|     Заказы      |     get     |        "/orders"        |          auth          |                               Получение страницы "Заказы"                                |
|     Заказы      |     post    |        "/orders"        |          auth          | Отправка данных на страницу "Заказы" через клавишу "Сделать заказ" на странице "Корзина" |




Все запросы страницы "Войти / выйти"
|Название страницы| Тип запроса |    URL-путь запроса     |       middleware       |                                     Краткое описание                                     |
| :-------------: | :---------: | :---------------------: | :--------------------: | :--------------------------------------------------------------------------------------: |
|   Вход / выход  |     get     |       "/auth/login"     |           -            |                   Отправка данных пользователя для входа в приложение                    |
|   Вход / выход  |     get     |       "/auth/loguot"    |           -            |                    Выход из приложения и закрытия сессии пользователя                    |
|   Вход / выход  |     get     |       "/auth/reset"     |           -            |                         Получение страницы восстановление пароля                         |
|   Вход / выход  |     get     | "/auth/password/:token" |           -            |                         Получение токена на восстановление пароля                        |
|   Вход / выход  |     post    |       "/auth/login"     |           -            |                   Отправка данных пользователя для входа в приложение                    |
|   Вход / выход  |     post    |      "/auth/register"   |    courseValidators    |           Отправка регистрационных данных для получения доступа в приложение             |
|   Вход / выход  |     post    |       "/auth/reset"     |           -            |       Отправка ранее регистрируемой почты для восстановления доступа в приложение        |
|   Вход / выход  |     post    |     "/auth/password"    |           -            |                   Отправка пароля пользователя для доступа в приложение                  |













### Контроллеры. Controllers

### **homeRoutes**

| Тип запроса | URL-путь запроса |                     Функция                  |
| :---------: | :--------------: | :------------------------------------------: |
|     get     |       "/"        |        Визуализация страницы "Главная"       |  
|     get     |       "/"        |      Определение флага активности ссылки     |  


#### Тип запроса `get` по маршруту `'/'`

---

Блок кода
```node
router.get('/', (req, res) => {
  res.render('index', {
    title: 'Главная страница',
    isHome: true
  })
})
```
Где:
**1. Визуализация страницы "Главная"**
Блок кода:
```node
...
res.render('index', {
    title: 'Главная страница',
    ...
  })
```
Где:
- `res.render('index', {})` - 
- `title` - `Главная страница`

**2. Определение флага активности ссылки**
```node
router.get('/', (req, res) => {
    ...
    isHome: true
  })
...
})
```
Где:
- `isHome` - `true` `res.render('index', {})`


### **coursesRoutes**

| Тип запроса |    URL-путь запроса     |                                  Функция                              |
| :---------: | :---------------------: | :-------------------------------------------------------------------: |
|     get     |        "/courses"       |                     Визуализация страницы "Курсов"                    |
|     get     |        "/courses"       |                  Определение флага активности ссылки                  |
|     get     |        "/courses"       |                    Поиск всех курсов в базе данных                    |
|     get     |        "/courses"       |                Визуализация всех курсов из базы данных                |
|     get     |      "/courses/:id"     |                   Визуализация страницы одного курса                  |
|     get     |      "/courses/:id"     |                Визуализация одного курса из базы данных               |
|     get     |   "/courses/:id/edit"   |                    Проверка на правильность запроса                   |
|     get     |   "/courses/:id/edit"   |                           Поиск курса по ID                           |
|     get     |   "/courses/:id/edit"   |       Проверка на доступность редактирование курса пользователем      |
|     get     |   "/courses/:id/edit"   |               Визуализация страницы "Редактировать курс"              |
|     post    |     "/courses/edit"     |                     Проверка валидации курса по ID                    |
|     post    |     "/courses/edit"     |                       Поиск курса в базе данных                       |
|     post    |     "/courses/edit"     |  Подтягивание всех существующих данных курса для его редактирования   |
|     post    |     "/courses/edit"     | Сохранение редактируемого курса и перенаправление на страницу "Курсы" |
|     post    |    "/courses/remove"    |                  Удаление одного курса из базы данных                 |
|     post    |    "/courses/remove"    |                  Перенаправление на страницу "Курсы"                  |

#### Тип запроса `get` по маршруту `'/courses'`

---

Полный блок кода:
```node
router.get('/', async (req, res) => {
  try {
    const courses = await Course.find()
    .populate('userId', 'email name')
    .select('price title img')

    res.render('courses', {
      title: 'Курсы',
      isCourses: true,
      userId: req.user ? req.user._id.toString() : null,
      courses
  })
  } catch (e) {
    console.log(e)
  }
})
```
Где:
1. **Визуализация страницы "Курсов"**
Блок кода
```node
res.render('courses', {})
```
Где:
- `res.render('courses', {})` - 

2. **Определение флага активности ссылки**
Блок кода
```node
...
isCourses: true
...
```
Где:
- `isCourses` - `true` `res.render('courses', {})` 

3. **Поиск всех курсов в базе данных**
Блок кода
```node
    const courses = await Course.find()
    .populate('userId', 'email name')
    .select('price title img')
```
Где:
- `Course.find()` -
- `populate` - `userId` `email name`
- `select` - `price title img`

4. **Визуализация всех курсов из базы данных**
Блок кода:
```node
res.render('courses', {
  ...
  courses
})
```
Где:
- `res.render('courses', {})` -
- `courses` - `courses`

#### Тип запроса `get` по маршруту `'/courses/:id'`

---

Полный блок кода:
```node
router.get('/:id', async (req, res) => {
  try {
    const course = await Course.findById(req.params.id)
    res.render('course', {
      layout: 'empty',
      title: `Курс ${course.title}`,
      course
    })
  } catch (e) {
    console.log(e)
  }
})
```
Где: 
1. **Визуализация страницы одного курса**
Блок кода
```node
res.render('course', {
      layout: 'empty',
      title: `Курс ${course.title}`,
      ...
    })
```
Где:
- `res.render('course', {})` -
- `layout` - `empty`
- `title` - `Курс ${course.title}`

2. **Визуализация одного курса из базы данных**
Блок кода:
```node
const course = await Course.findById(req.params.id)

res.render('course', {
  ...
  course
})
```
Где:
- `await Course.findById(req.params.id)` -
- `course` - `res.render('course', {})`

#### Тип запроса `get` по маршруту `'/courses/:id/edit'`

---

Полный блок кода:
```node
router.get('/:id/edit', auth, async (req, res) => {
  if (!req.query.allow) {
    return res.redirect('/')
  }
  try {
    const course = await Course.findById(req.params.id)

    if (course.userId.toString() !== req.user._id.toString()) {
      return res.redirect('/courses')
    }
    
    res.render('course-edit', {
      title: `Редактировать ${course.title}`,
      course
  })
  } catch (e) {
    console.log(e)
  }
})
```
Где:
1. **Проверка на правильность запроса**
Блок кода:
```node
...
  if (!req.query.allow) {
    return res.redirect('/')
  }
...
```
Где:
- `!req.query.allow` -
- `res.redirect()` - `'/'`

2. **Поиск курса по ID**
Блок кода:
```node
...
const course = await Course.findById(req.params.id)
...
```
Где:
- `Course.findById()` - `req.params.id`

3. **Проверка на доступность редактирование курса пользователем**
Блок кода:
```node
...
if (course.userId.toString() !== req.user._id.toString()) {
      return res.redirect('/courses')
    }
...
```
Где:
- `course.userId.toString() !== req.user._id.toString()` -
- `res.redirect()` - `'/courses'`

4. **Визуализация страницы "Редактировать курс"**
Блок кода:
```node
...
res.render('course-edit', {
      title: `Редактировать ${course.title}`,
      ...
  })
```
Где:
- `res.render('course-edit', {})` -
- `title: Редактировать ${course.title}` -


5. **Визуализация одного курса**
Блок кода:
```node
const course = await Course.findById(req.params.id)
  ...
res.render('course-edit', {
      ...,
      course
  })
```
Где:
- `Course.findById(req.params.id)` -
- `res.render('course-edit', {})` - 
- `course` - `res.render('course-edit', {})`

#### Тип запроса `post` по маршруту `'/courses/edit'`

---

Полный блок кода:
```node
router.post('/edit', auth, courseValidators, async (req, res) => {
  const errors = validationResult(req)
  const {id} = req.body

  if (!errors.isEmpty()) {
    return res.status(422).redirect(`/courses/${id}/edit?allow=true`)
  }

  try {
    delete req.body.id
    const course = await Course.findById(id)
    if (course.userId.toString() !== req.user._id.toString()) {
      res.redirect('/courses')
    }
    Object.assign(course, req.body)
    await course.save()
    res.redirect('/courses')
  } catch (e) {
    console.log(e)
  }
})
```
Где:
1. **Проверка валидации курса по ID**
Блок кода:
```node
...
  if (!errors.isEmpty()) {
    return res.status(422).redirect(`/courses/${id}/edit?allow=true`)
  }
...
```
Где:
- `!errors.isEmpty()` -
- `res.status(422)` -
- `redirect()` - `/courses/${id}/edit?allow=true`


2. **Поиск курса в базе данных**
Блок кода:
```node
const course = await Course.findById(id)
```
Где:
- `Course.findById()` - `id`

3. **Подтягивание всех существующих данных курса для его редактирования**
Блок кода:
```node
const course = await Course.findById(id)
...
Object.assign(course, req.body)
...
```
Где:
- `Object.assign()` - `course` `req.body`


4. **Сохранение редактируемого курса и перенаправление на страницу "Курсы"**
Блок кода:
```node
...
await course.save()
res.redirect('/courses')
...
```
Где:
- `course.save()` -
- `res.redirect()` - `'/courses'`

#### Тип запроса `post` по маршруту `'/courses/remove'`

---

Полный блок кода:
```node
router.post('/remove', auth, async (req, res) => {
  try {
    await Course.deleteOne({
      _id: req.body.id, 
      userId: req.user._id
    })
    res.redirect('/courses')
  } catch (e) {
    console.log(e)
  }
})
```
Где:
1. **Удаление одного курса из базы данных**
Блок кода:
```node
await Course.deleteOne({
      _id: req.body.id, 
      userId: req.user._id
    })
```
Где:
- `Course.deleteOne({})` -
  - `_id` - `req.body.id`
  - `userId` - `req.user._id`

2. **Перенаправление на страницу "Курсы"**
```node
router.post('/remove', auth, async (req, res) => {
  ...
  res.redirect('/courses')
  ...
})
```
Где: 
- `res.redirect()` - `'/courses'`



### addRoutes

| Тип запроса | URL-путь запроса |       Страница      |                    Функция                  |
| :---------: | :--------------: | :-----------------: | :-----------------------------------------: |
|     get     |      "/add"      | Добавить новый курс | Визуализация страницы "Добавить новый курс" |
|     get     |      "/add"      | Добавить новый курс |     Определение флага активности ссылки     |
|     post    |      "/add"      | Добавить новый курс |     Проверка валидатором на пустые поля     | 
|     post    |      "/add"      | Добавить новый курс |            Создание нового курса            | 
|     post    |      "/add"      | Добавить новый курс |    Сохранение нового курса в базе данных    | 

#### Тип запроса `get` по маршруту `'/add'`

---
Полный блок кода
```node
router.get('/', auth, (req, res) => {
  res.render('add', {
    title: 'Добавить курс',
    isAdd: true
  })
})
```
Где:
1. **Визуализация страницы "Добавить новый курс"**
```node
...
res.render('add', {
    title: 'Добавить курс',
    ...
  })
})
```
Где:
- `res.render('add', {})` -
- `title` - `Добавить курс`
2. **Определение флага активности ссылки**
```node
...
  res.render('add', {
    ...
    isAdd: true
  })
...
```
Где:
- `isAdd` - `true` 



#### Тип запроса `post` по маршруту `'/add'`

----

```node
router.post('/', auth, courseValidators, async (req, res) => {

  const errors = validationResult(req)
  if (!errors.isEmpty()) {
    return res.status(422).render('add', {
      title: 'Добавить курс',
      isAdd: true,
      error: errors.array()[0].msg,
      data: {
        title: req.body.title,
        price: req.body.price,
        img: req.body.img
      }
    })
  }

  const course = new Course({
    title: req.body.title,
    price: req.body.price,
    img: req.body.img,
    userId: req.user
})
    await course.save()
    res.redirect('/courses')
})
```
Где:
1. **Проверка валидатором на пустые поля:**
```node
...
  if (!errors.isEmpty()) {
    ...
  }
...
```
Где:
- `!errors.isEmpty()` - 

2. **Создание нового курса:**
```node
...
  const course = new Course({
    title: req.body.title,
    price: req.body.price,
    img: req.body.img,
    userId: req.user
})
...
```
Где:
- `const course = new Course({})` - 
  - `title` - `req.body.title`
  - `price` - `req.body.price`
  - `img` - `req.body.img`
  - `userId` - `req.user`
3. **Сохранение нового курса в базе данных:**
```node
...
    await course.save()
    res.redirect('/courses')
...
```
Где:
- `course.save()` - 
- `res.redirect('/courses')` -

### profileRoutess

| Тип запроса | URL-путь запроса |                                      Функция                                   |
| :---------: | :--------------: | :----------------------------------------------------------------------------: |
|     get     |    "/profile"    |                         Визуализация страницы "Профиль"                        |
|     get     |    "/profile"    |                       Определение флага активности ссылки                      |
|     get     |    "/profile"    |                        Визуализация данных пользователя                        |
|     post    |    "/profile"    |                            Поиск пользователя по ID                            |
|     post    |    "/profile"    |   Подтягивание всех существующих данных пользователя для его редактирования    |
|     post    |    "/profile"    |                          Редактирование имени пользователя                     |
|     post    |    "/profile"    | Сохранение редактируемого пользователя и перенаправление на страницу "Профиль" |


#### Тип запроса `get` по маршруту `'/profile'`
Полный блок кода:
```node
router.get('/', auth, async (req, res) => {
  res.render('profile', {
    title: 'Профиль',
    isProfile: true,
    user: req.user.toObject()
  })
})
```
Где:
1. Визуализация страницы "Профиль":
Блок кода:
```node

```
Где:
- `` -
- `` -
2. Определение флага активности ссылки:
Блок кода:
```node

```
Где:
- `` -
- `` -
3. Визуализация данных пользователя:
Блок кода:
```node

```
Где:
- `` -
- `` -

#### Тип запроса `post` по маршруту `'/profile'`
Полный блок кода:
```node

```
Где:
1. Поиск пользователя по ID
2. Подтягивание всех существующих данных пользователя для его редактирования
3. Редактирование имени пользователя
4. Сохранение редактируемого пользователя и перенаправление на страницу "Профиль"




### cardRoutes


| Тип запроса |  URL-путь запроса  |                                Функция                             |
| :---------: | :----------------: | :----------------------------------------------------------------: |
|     get     |      "/card"       |                 Визуализация корзины пользователя                  |
|     get     |      "/card"       |                Определение флага активности ссылки                 |
|     get     |      "/card"       |                    Расчёт стоимости всех курсов                    |
|     get     |      "/card"       |                   Визуализация страницы "Корзина"                  |
|     post    |    "/card/add"     |                         Поиск курса по ID                          |
|     post    |    "/card/add"     | Добавление курса в корзину и перенаправление на страницу "Корзина" |
|    delete   | "/card/remove/:id" |                   Удаление курса по ID из корзины                  |
|    delete   | "/card/remove/:id" |         Пересчёт стоимости всех курсов после удаления курса        |
|    delete   | "/card/remove/:id" |               Визуализация всех курсов из "Корзины"                |


#### Тип запроса `get` по маршруту `'/card'`
Полный блок кода:
```node

```
Где:
1. Визуализация корзины пользователя
2. Определение флага активности ссылки
3. Расчёт стоимости всех курсов
4. Визуализация страницы "Корзина"

#### Тип запроса `post` по маршруту `'/card/add'`
Полный блок кода:
```node

```
где:
1. Поиск курса по ID
2. Добавление курса в корзину и перенаправление на страницу "Корзина"

#### Тип запроса `delete` по маршруту `'/card/remove/:id'`
Полный блок кода:
```node

```
где:
1. Удаление курса по ID из корзины
2. Пересчёт стоимости всех курсов после удаления курса
3. Визуализация всех курсов из "Корзины"




### ordersRoutes


| Тип запроса | URL-путь запроса |                           Функция                        |
| :---------: | :--------------: | :------------------------------------------------------: |
|     get     |     "/orders"    |             Поиск заказов пользователя по ID             |
|     get     |     "/orders"    |              Визуализация страницы "Заказы"              |
|     get     |     "/orders"    |               Подсчёт стоимости всех курсов              |
|     post    |     "/orders"    |                  Определение юзера по ID                 |
|     post    |     "/orders"    |          Подсчёт всех курсов и суммы этих курсов         |
|     post    |     "/orders"    |                Формирование нового заказа                |
|     post    |     "/orders"    | Сохранение заказа и перенаправление на страницу "Заказы" |
|     post    |     "/orders"    |                   Очищение корзины                       |


#### Тип запроса `get` по маршруту `'/orders'`
Полный блок кода:
```node

```
Где:
1. Поиск заказов пользователя по ID
2. Визуализация страницы "Заказы"
3. Подсчёт стоимости всех курсов

#### Тип запроса `post` по маршруту `'/orders'`
Полный блок кода:
```node

```
Где:
1. Определение юзера по ID
2. Подсчёт всех курсов и суммы этих курсов
3. Формирование нового заказа
4. Сохранение заказа и перенаправление на страницу "Заказы"
5. Очищение корзины




### authRoutes


| Тип запроса |    URL-путь запроса     |                           Функция                        |
| :---------: | :---------------------: | :------------------------------------------------------: |
|     get     |      "/auth/login"      | Визуализация страницы "Вход" |
|     get     |      "/auth/login"      | Определение флага активности ссылки |
|     get     |      "/auth/login"      | Проверка на подлинность логика пользователя |
|     get     |      "/auth/login"      | Проверка на подлинность пароль пользователя |
|     get     |      "/auth/loguot"     | Уничтожение сессии пользователя и перенаправление на страницу "Вход" |
|     get     |       "/auth/reset"     | Визуализация страницы "Смена пароля" |
|     get     |       "/auth/reset"     | Проверка на существующую почту пользователя в базе данных |
|     get     | "/auth/password/:token" | Проверка на действенный токен пользователя |
|     get     | "/auth/password/:token" | Поиск пользователя по действительному токену |
|     get     | "/auth/password/:token" | Проверка на существование уникально пользователя |
|     get     | "/auth/password/:token" | Визуализация страницы "Востановить доступ" |
|     get     | "/auth/password/:token" | Проверка на восстановление доступа конкретному пользователю|
|     post    |       "/auth/login"     | Проверка данных пользователя для входа в аккаунт |
|     post    |       "/auth/login"     | Получение пользователем авторизированных прав и открытие сессии |
|     post    |       "/auth/login"     | Проверка на правильность пароля |
|     post    |      "/auth/register"   | Проверка вводимых данных валидатором |
|     post    |      "/auth/register"   | Создание аккаунта нового пользователя и шифрование пароля пользователя |
|     post    |      "/auth/register"   | Сохранение данных пользователя в базе данных |
|     post    |      "/auth/register"   | Отправка письма пользователю об успешной регистрации |
|     post    |       "/auth/reset"     | Поиск пользователю в базе данных |
|     post    |       "/auth/reset"     | Проверка email на существование пользователя с таким email в базе данных |
|     post    |       "/auth/reset"     | Отправка сообщения с новым токеном на почту существующему пользователю |
|     post    |     "/auth/password"    | Поиск пользователя по ID |
|     post    |     "/auth/password"    | Сохранение нового пароля пользователя в базе данных и перенаправление на страницу "Логин" |
|     post    |     "/auth/password"    | Проверка на срок жизни токена |


#### Тип запроса `get` по маршруту `'/auth/login'`
Полный блок кода:
```node

```
Где:
1. Визуализация страницы "Вход"
2. Определение флага активности ссылки
3. Проверка на подлинность логика пользователя
4. Проверка на подлинность пароль пользователя

#### Тип запроса `get` по маршруту `'/auth/loguot'`
Полный блок кода:
```node

```
Где:
1. Уничтожение сессии пользователя и перенаправление на страницу "Вход"

#### Тип запроса `get` по маршруту `'/auth/reset'`
Полный блок кода:
```node

```
Где:
1. Визуализация страницы "Смена пароля"
2. Проверка на существующую почту пользователя в базе данных

#### Тип запроса `get` по маршруту `'/auth/password/:token'`
Полный блок кода:
```node

```
Где:
1. Проверка на действенный токен пользователя
2. Поиск пользователя по действительному токену
3. Проверка на существование уникально пользователя
4. Визуализация страницы "Востановить доступ"
5. Проверка на восстановление доступа конкретному пользователю

#### Тип запроса `post` по маршруту `'/auth/login'`
Полный блок кода:
```node

```
Где:
1. Проверка данных пользователя для входа в аккаунт
2. Получение пользователем авторизированных прав и открытие сессии
3. Проверка на правильность пароля

#### Тип запроса `post` по маршруту `'/auth/register'`
Полный блок кода:
```node

```
Где:
1. Проверка вводимых данных валидатором
2. Создание аккаунта нового пользователя и шифрование пароля пользователя
3. Сохранение данных пользователя в базе данных
4. Отправка письма пользователю об успешной регистрации

#### Тип запроса `post` по маршруту `'/auth/reset'`
Полный блок кода:
```node

```
Где:
1. Поиск пользователя в базе данных
2. Проверка email на существование пользователя с таким email в базе данных
3. Отправка сообщения с новым токеном на почту существующему пользователю


#### Тип запроса `post` по маршруту `'/auth/password'`
Полный блок кода:
```node

```
Где:
1. Поиск пользователя по ID
2. Сохранение нового пароля пользователя в базе данных и перенаправление на страницу "Логин"
3. Проверка на срок жизни токена



































---------------------------------------------------------------------------------------------------------------------------------------------------------------------

### Промежуточные обработчики. Middleware

Глобальные промежуточные обработчики:
|          Функция    -      | Пакет npm |                        Короткое описание                         |
| :------------------------: | :-------: | :--------------------------------------------------------------: |
| authentificationMiddleware |   crsf    | Определяет наличие crsf токен, как определение прав пользователя |
|   userSessionMiddleware    |  session  |   Определяет и сохраняет данные сессий отдельных пользователей   |
|       fileMiddleware       |  multer   |                Загрузка определенных типов файлов                |
|        errorHandler        |     -     |              В случае ошибки - отправка страницы 404             |


Локальные промежуточные обработчики:
|      Функция       |     Пакет npm     |                         Короткое описание                         |
| :----------------: | :---------------: | :---------------------------------------------------------------: |
|         auth       |      session      | Если пользователь зарегестирован - доступ есть, иначе доступа нет |
| registerValidators | express-validator |           Проверяет правильность данных при регистрации           |
|  courseValidators  | express-validator |          Проверяет правильность данных при создании курса         |


```node
const csrf = require('csurf')
app.use(csrf())
```
Блок кода глобального промежуточного обработчика
```
const compression = require('compression')
app.use(compression())
```
Блок кода глобального промежуточного обработчика
```node
const flash = require('connect-flash')
app.use(flash())
```
Блок кода глобального промежуточного обработчика
```node
app.use(helmet({
  contentSecurityPolicy: {
     directives: {
        ...helmet.contentSecurityPolicy.getDefaultDirectives(),
        "img-src": ["'self'", "https:"],
        "script-src-elem": ["'self'", "https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js", "'unsafe-inline'" ] 
     },
  }
 }))
```
Где: 
- `helmet` - 
- `contentSecurityPolicy` - 
- `directives` -
- `...helmet.contentSecurityPolicy.getDefaultDirectives()` -
- `img-src` - `["'self'", "https:"]`
- `script-src-elem` - `["'self'", "https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js", "'unsafe-inline'" ]`


```node
app.use(session({
  secret: keys.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  store
}))
```
Где:
- `session({})` -
- `secret` - `keys.SESSION_SECRET`
- `resave` - `false`
- `saveUninitialized` - `false`
- `store` - `MongoStore`


-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## SendGrid


Все почтовые письма: 
|         Тип письма        |                        Задача письма                         |
| :-----------------------: | :----------------------------------------------------------: |
| Подтверждение регистрации | Уведомить пользователя об подтверждении успешной регистрации |
|   Восстановление пароля   | Прислать токен с ограниченным сроком жизни для смены пароль  |

-----------------------------------------------------------------------------------------------------------------------------------------------------------------


# Представления. Views

```node
const exphbs = require('express-handlebars')

const hbs = exphbs.create({
  defaultLayout: 'main',
  extname: 'hbs',
  helpers: require('./utils/hbs-helpers')
})
```
Где:
- `exphbs.create({})` -
- `defaultLayout` -
- `extname` -
- `helpers` -

```node
app.engine('hbs', hbs.engine)
app.set('view engine', 'hbs')
app.set('views', 'views')
```



Таблица всех представлений:

|   Блок   | Представление |                             Примечание                            | 
| :------: | :-----------: | :---------------------------------------------------------------: |
|   auth   |     login     |               Страница входа в аккаунт пользователя               |
|   auth   |   password    |             Страница ввода нового пароля пользователя             |
|   auth   |     reset     |                Страница сброса пароля пользователя                |
| layouts  |     empty     |             Слой разметки страницы вывода одного курса            |
| layouts  |     main      | Слой разметки для всех страниц кроме страницы вывода одного курса |
| partials |    footer     |             Часть слоя, отвечающая за footer разметки             |
| partials |     head      |             Часть слоя, отвечающая за header разметки             |
| partials |    navbar     |             Часть слоя, отвечающая за navbar разметки             |
|     -    |      404      |                           Страница 404                            |
|     -    |      add      |                   Страница "Добавить новый курс"                  |
|     -    |     card      |                          Страница "Корзина"                       |
|     -    |  course-edit  |                   Страница "Редактировать курс"                   |
|     -    |    course     |                       Страница одного курса                       |
|     -    |    courses    |                         Страница "Курсы"                          |
|     -    |     index     |                         Страница "Главная"                        |
|     -    |    orders     |                         Страница "Заказы"                         |
|     -    |    profile    |                         Страница "Профиль"                        |




## Структура страницы. 


Пояснить за структуру кода


пояснить за лайоуты

### layouts

main.hbs структура листа
```handlebars 
{{> head }}
<body>
  {{> navbar}}

  <div class="container">
    {{{ body }}}
  </div>

{{> footer}}
</body>
</html>
```
Где:
- `{{> head}}` - 
- `{{> navbar}}` - 
- `{{{ body }}}` - 
- `{{> footer}}` - 


## head

Блок кода
head.hbs
```handlebars
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="/index.css">
  <title>{{title}}</title>
</head>
```
Где:
- `{{title}}` -

### navbar

Блок кода
navbar.hbs
```handlebars
<nav>
  <div class="nav-wrapper">
    <a href="/" class="brand-logo">Магазин курсов</a>
    <ul id="nav-mobile" class="right hide-on-med-and-down">
      {{#if isHome}}
        <li class="active"><a href="/">Главная</a></li>
      {{else}}
        <li><a href="/">Главная</a></li>
      {{/if}}
      ...
    </ul>
  </div>
</nav>
```
Где:
- `class="active"` - 


### footer

Блок кода
footer.hbs
```handlebars
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="/app.js"></script>
```
Где:
- `https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js` -
- `/app.js` -







Таблица представлений слоёв, на которые накладывается разметка страниц:
| Представление |                        Предназначение слоя                        | 
| :-----------: | :---------------------------------------------------------------: |
|     empty     |             Слой разметки страницы вывода одного курса            |
|     main      | Слой разметки для всех страниц кроме страницы вывода одного курса |





Таблица представлений отвечающие за части слоя main
| Представление |                            Зона участка                           | 
| :-----------: | :---------------------------------------------------------------: |
|    footer     |             Часть слоя, отвечающая за footer разметки             |
|     head      |             Часть слоя, отвечающая за header разметки             |
|    navbar     |             Часть слоя, отвечающая за navbar разметки             |





Таблица представлений отвечающие за отрисовку страниц приложения:
| Представление |                         Страницы приложения                       | 
| :-----------: | :---------------------------------------------------------------: |
|      404      |                           Страница 404                            |
|      add      |                   Страница "Добавить новый курс"                  |
|     card      |                          Страница "Корзина"                       |
|  course-edit  |                   Страница "Редактировать курс"                   |
|    course     |                       Страница одного курса                       |
|    courses    |                         Страница "Курсы"                          |
|     index     |                         Страница "Главная"                        |
|    orders     |                         Страница "Заказы"                         |
|    profile    |                         Страница "Профиль"                        |





Таблица представлений страниц, отвечающие за отрисовку страниц авторизации:
| Представление |                        Страница авторизации                       | 
| :-----------: | :---------------------------------------------------------------: |
|     login     |               Страница входа в аккаунт пользователя               |
|   password    |             Страница ввода нового пароля пользователя             |
|     reset     |                Страница сброса пароля пользователя                |

